# Architecture Guide

## Overview

Catalyst follows a modern Rails 8 architecture with Phlex-based views, service-oriented business logic, and component-driven UI development.

## Directory Structure

```
app/
├── components/               # Phlex components
│   ├── ruby_ui/             # Generated Ruby UI components
│   │   ├── button/
│   │   ├── card/
│   │   └── ...
│   └── layout/              # Custom layout components
│       ├── application.rb
│       └── navbar.rb
├── controllers/             # Rails controllers
│   ├── concerns/           # Controller concerns
│   │   ├── auth_provider.rb
│   │   └── secured.rb
│   ├── auth0_controller.rb
│   ├── pages_controller.rb
│   └── profile_controller.rb
├── models/                 # ActiveRecord models
│   └── user.rb
├── services/              # Business logic services
│   └── locale_service.rb
└── views/                 # Phlex view classes
    ├── auth0/
    ├── pages_home.rb
    └── profile/
```

## View Layer Architecture

### Phlex as the View Layer

Catalyst uses **Phlex** instead of traditional ERB templates, providing:
- Type safety and better IDE support
- Component composition
- Easier testing
- Better performance

### Namespace Organization

#### `Views::` Namespace
Application-specific view classes in `app/views/`:

```ruby
# app/views/pages_home.rb
class Views::PagesHome < Views::Base
  def view_template
    div(class: "container mx-auto px-4 py-16") do
      header_section
      features_section
    end
  end

  private

  def header_section
    h1(class: "text-5xl font-bold") { t("views.pages_home.title") }
  end
end
```

#### `Components::` Namespace
Reusable components in `app/components/`:

```ruby
# app/components/layout/navbar.rb
class Layout::Navbar < Components::Base
  def view_template
    nav(class: "bg-white shadow") do
      div(class: "container mx-auto flex items-center justify-between") do
        brand_section
        navigation_section
      end
    end
  end
end
```

### Base Classes

#### `Views::Base`
Base class for application views:

```ruby
# app/views/base.rb
class Views::Base < Phlex::HTML
  include Phlex::Rails::Helpers::Routes
  include Phlex::Rails::Helpers::CSRF
  
  # Register Rails helpers
  register_value_helper :current_user
  register_value_helper :logged_in?
  register_value_helper :t
  
  private
  
  def page_title(title = nil)
    content_for(:title, title) if title
  end
end
```

#### `Components::Base`
Base class for application components:

```ruby
# app/components/base.rb
class Components::Base < Phlex::HTML
  include Phlex::Rails::Helpers::Routes
  
  register_value_helper :current_user
  register_value_helper :logged_in?
  register_value_helper :t
end
```

#### `Components::RubyUI::Base`
Base class for Ruby UI components:

```ruby
# Generated by ruby_ui gem
class Components::RubyUI::Base < Phlex::HTML
  include TailwindMerge::Phlex
  # Ruby UI specific functionality
end
```

### Component Composition

```ruby
class Views::Profile::Show < Views::Base
  def view_template
    render Layout::Application.new do
      div(class: "container mx-auto py-8") do
        render RubyUI::Card::Card.new do
          render RubyUI::Card::CardHeader.new do
            render RubyUI::Card::CardTitle.new do
              t("profile.title")
            end
          end
          
          render RubyUI::Card::CardContent.new do
            render Profile::InfoSection.new(user: @user)
          end
        end
      end
    end
  end
end
```

## Services Architecture

### Service Pattern
Business logic is extracted into service classes to keep controllers thin:

```ruby
# app/services/locale_service.rb
class LocaleService
  def self.available_locales
    locale_files = Dir.glob(Rails.root.join("config", "locales", "*.yml"))
    locale_files.map { |file| File.basename(file, ".yml").to_sym }
  end

  def self.language_options
    available_locales.map do |locale|
      [format_language_option(locale), locale.to_s]
    end
  end

  private

  def self.format_language_option(locale)
    native_name = locale_name(locale, native: true)
    translated_name = locale_name(locale, native: false)

    if native_name == translated_name
      native_name
    else
      "#{native_name} (#{translated_name})"
    end
  end
end
```

### Service Usage

```ruby
# In controllers
class ApplicationController < ActionController::Base
  around_action :set_locale

  private

  def set_locale(&action)
    locale = params[:locale] || session[:locale] || I18n.default_locale
    session[:locale] = locale if LocaleService.available_locales.include?(locale.to_sym)
    I18n.with_locale(locale, &action)
  end
end

# In views
class Views::Profile::Edit < Views::Base
  def language_select
    select(name: "locale") do
      LocaleService.language_options.each do |label, value|
        option(value: value, selected: (value == I18n.locale.to_s)) { label }
      end
    end
  end
end
```

## Controller Architecture

### Authentication Concerns

#### AuthProvider Concern
Manages authentication state:

```ruby
module AuthProvider
  extend ActiveSupport::Concern

  included do
    helper_method :logged_in?, :current_user, :current_auth_provider_user
  end

  def current_auth_provider_user
    @current_auth_provider_user ||= session[:userinfo]
  end

  def current_user
    return nil unless logged_in?
    @current_user ||= User.find_or_create_from_auth_provider(current_auth_provider_user)
  end

  def logged_in?
    session[:userinfo].present?
  end
end
```

#### Secured Concern
Provides authorization:

```ruby
module Secured
  extend ActiveSupport::Concern

  included do
    before_action :require_authentication
  end

  private

  def require_authentication
    unless logged_in?
      session[:return_to] = request.fullpath
      redirect_to "/auth/auth0", allow_other_host: true
    end
  end
end
```

### Controller Patterns

```ruby
class ProfileController < ApplicationController
  include AuthProvider
  include Secured  # Requires authentication

  def show
    @user = current_user
  end

  def edit
    @user = current_user
  end

  def update
    @user = current_user
    
    if @user.update(user_params)
      redirect_to profile_path, notice: t("flash.profile.updated")
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:name, :email)
  end
end
```

## Model Architecture

### User Model
Central user model with authentication integration:

```ruby
class User < ApplicationRecord
  validates :email, presence: true, uniqueness: true
  validates :name, presence: true

  def self.find_or_create_from_auth_provider(auth_info)
    email = auth_info['email']
    raise ArgumentError, "Email is required from authentication provider" if email.blank?
    
    find_or_create_by(email: email) do |user|
      user.name = auth_info['name']
      user.auth_provider_id = auth_info['sub']
    end
  end

  def display_name
    name.presence || email
  end
end
```

## Asset Architecture

### Propshaft Pipeline
Rails 8's modern asset pipeline:
- Fingerprinted assets for cache busting
- ES modules with importmap
- Direct file serving without transpilation

### Tailwind CSS 4
Modern CSS framework:
- Utility-first approach
- Design tokens
- Component layer for Ruby UI
- Dark mode support

### TailwindMerge
Class composition utility:
```ruby
# In Ruby UI components
class RubyUI::Button::Button < Components::RubyUI::Base
  def view_template(&block)
    button(**merge_attrs(attrs, { class: merged_classes }), &block)
  end

  private

  def merged_classes
    merge_classes([
      base_classes,
      variant_classes,
      size_classes,
      @class
    ])
  end
end
```

## Configuration Architecture

### Application Configuration

```ruby
# config/application.rb
module Catalyst
  class Application < Rails::Application
    config.load_defaults 8.0
    
    # Phlex view configuration
    config.autoload_paths << Rails.root.join("app/views")
    
    # I18n configuration
    config.i18n.available_locales = [:en, :es, :da]
    config.i18n.default_locale = :en
    config.i18n.fallbacks = true
  end
end
```

### Solid Queue/Cache/Cable
Rails 8's built-in background job and caching system:

```ruby
# config/queue.yml
production:
  adapter: solid_queue
  
# config/cache.yml  
production:
  adapter: solid_cache
  
# config/cable.yml
production:
  adapter: solid_cable
```

## Testing Architecture

### Test Structure
```
spec/
├── components/           # Component specs
│   ├── ruby_ui/
│   └── layout/
├── controllers/         # Controller specs
├── models/             # Model specs
├── requests/           # Integration specs
├── services/           # Service specs
├── support/            # Test helpers
│   ├── auth_helpers.rb
│   └── component_helpers.rb
└── factories/          # FactoryBot factories
```

### Component Testing
```ruby
# spec/components/layout/navbar_spec.rb
RSpec.describe Layout::Navbar, type: :component do
  it "renders navigation items" do
    component = described_class.new
    rendered = render_with_view_context(component)
    
    expect(rendered).to have_selector("nav")
    expect(rendered).to have_link("Home")
  end
end
```

## Performance Architecture

### Caching Strategy
- **Page caching**: For static pages
- **Fragment caching**: For expensive partials
- **Model caching**: With Solid Cache

```ruby
# In views
cache @user do
  render Profile::ExpensiveSection.new(user: @user)
end
```

### Database Optimization
- **SQLite in production**: For single-server deployments
- **Connection pooling**: Configured for concurrent requests
- **Query optimization**: With includes and joins

### Asset Optimization
- **Fingerprinting**: Automatic cache busting
- **Compression**: Gzip/Brotli compression
- **CDN ready**: Static asset serving

## Security Architecture

### Authentication Security
- **OAuth 2.0/OpenID Connect**: Via Auth0
- **CSRF protection**: Built-in Rails protection
- **Session security**: Secure cookie configuration

### Authorization
- **Controller-level**: Via `Secured` concern  
- **View-level**: Conditional rendering based on auth state
- **Route protection**: Authentication required for sensitive routes

### Data Protection
- **SQL injection**: ActiveRecord parameterization
- **XSS protection**: Phlex automatic escaping
- **HTTPS enforcement**: In production configuration

## Deployment Architecture

### Docker Containerization
```dockerfile
# Multi-stage build for optimization
FROM ruby:3.4-alpine AS builder
# Build dependencies and assets

FROM ruby:3.4-alpine AS runtime  
# Runtime dependencies only
```

### Kamal Deployment
- **Zero-downtime deployments**
- **SSL termination**: Let's Encrypt integration
- **Health checks**: Automatic rollback on failure
- **Asset persistence**: Shared volumes for assets

### Monitoring
- **Application logs**: Via Rails logging
- **System metrics**: Server resource monitoring
- **Error tracking**: Integration-ready for Sentry/Rollbar
- **Uptime monitoring**: Health check endpoints